{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ sala.nombre }} - Calendario</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css">
    <link rel="stylesheet" href="{% static 'css/calendario.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/locale/es.js"></script>
</head>

<body>
    <!-- Elemento para el efecto de luz ambiental -->
    <div class="ambient-light"></div>

    <div class="container">
        <div class="header-container">
            <a href="{% url 'accounts:visor_admin' %}" class="admin-link">
                <span class="icon"></span>
                <span class="text">Panel Admin</span>
            </a>
            <div class="header-title">
                <h1>{{ sala.nombre }}</h1>
                <p class="subtitle">Calendario de disponibilidad</p>
                <div class="decoration-line"></div>
            </div>
        </div>

        <div class="calendar-container">
            <div class="calendar-wrapper">
                <div id="calendario"></div>
            </div>
        </div>
    </div>

    <!-- Modal de horarios mejorado -->
    <div id="horariosModal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <span class="icon">üìÖ</span>
                    Horarios Disponibles - <span id="selectedDateText"></span>
                </h3>
                <button class="close-modal">
                    <span class="icon">√ó</span>
                </button>
            </div>

            <div class="modal-body">
                <div id="loadingSpinner" class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Cargando horarios...</p>
                </div>

                <div id="horariosDisponibles" class="horarios-grid"></div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">
                    <span class="icon">‚Ü©</span>
                    Cancelar
                </button>
                <button id="btnReservar" class="btn btn-primary" onclick="realizarReserva()">
                    <span class="icon">‚úì</span>
                    Reservar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let selectedDate = moment();
        let selectedHorario = null;

        $(document).ready(function () {
            initializeCalendar();
            setupEventListeners();
            removeGreenBackground();
        });

        // Funci√≥n para eliminar fondos verdes
        function removeGreenBackground() {
            // Remover fondos verdes de todas las celdas
            $('.fc td, .fc-bgevent, .fc-nonbusiness, .fc-highlight').css({
                'background': 'transparent !important',
                'background-color': 'transparent !important'
            });

            // Aplicar estilos peri√≥dicamente para asegurar que no aparezcan fondos verdes
            setInterval(() => {
                $('.fc td, .fc-bgevent, .fc-nonbusiness, .fc-highlight').css({
                    'background': 'transparent !important',
                    'background-color': 'transparent !important'
                });
            }, 100);
        }

        function initializeCalendar() {
            $('#calendario').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                defaultView: 'month',
                locale: 'es',
                timeZone: 'local',
                selectable: true,
                selectHelper: true,
                editable: false,
                eventLimit: true,
                events: '/api/sala/{{ sala.id }}/reservas/',
                dayClick: handleDayClick,
                longPressDelay: 100,
                eventLongPressDelay: 100,
                selectLongPressDelay: 100,
                // Personalizaci√≥n de d√≠as disponibles con verde ne√≥n
                dayRender: function (date, cell) {
                    // Remover cualquier fondo verde
                    cell.css('background', 'transparent');

                    // Si la fecha es futura, aplicar borde verde ne√≥n
                    if (date.isAfter(moment(), 'day')) {
                        cell.css({
                            'border': '2px solid #22c55e', // Verde ne√≥n
                            'box-shadow': '0 0 10px rgba(34, 197, 94, 0.4), 0 0 20px rgba(34, 197, 94, 0.2)',
                            'position': 'relative',
                            'z-index': '1',
                            'background': 'transparent'
                        });
                    }
                },
                viewRender: function (view, element) {
                    removeGreenBackground();

                    // Mejorar la apariencia de d√≠as disponibles
                    $('.fc-future').each(function () {
                        $(this).css({
                            'transition': 'all 0.3s ease',
                            'cursor': 'pointer',
                            'background': 'transparent'
                        });
                    });
                }
            });
        }

        function setupEventListeners() {
            // Event listeners para el modal
            $('.close-modal, .modal-backdrop').on('click', closeModal);
            $('.modal-content').on('click', function (e) {
                e.stopPropagation();
            });

            // Mejorar hover en d√≠as disponibles con verde ne√≥n
            $(document).on('mouseenter', '.fc-future', function () {
                $(this).css({
                    'border-color': '#16a34a', // Verde m√°s intenso para hover
                    'box-shadow': '0 0 15px rgba(34, 197, 94, 0.6), 0 0 30px rgba(34, 197, 94, 0.3)',
                    'transform': 'scale(1.02)',
                    'background': 'transparent'
                });
            }).on('mouseleave', '.fc-future', function () {
                $(this).css({
                    'border-color': '#22c55e', // Volver al verde ne√≥n original
                    'box-shadow': '0 0 10px rgba(34, 197, 94, 0.4), 0 0 20px rgba(34, 197, 94, 0.2)',
                    'transform': 'scale(1)',
                    'background': 'transparent'
                });
            });

            // Soporte para dispositivos t√°ctiles
            if ('ontouchstart' in window) {
                setupTouchHandlers();
            }

            // Manejar teclas de escape
            $(document).on('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        // Modificar la funci√≥n setupTouchHandlers
        function setupTouchHandlers() {
            let touchStartTime;
            const LONG_PRESS_DURATION = 500;

            // Prevenir el scroll solo en elementos espec√≠ficos
            $('.fc-day').on('touchstart', function (e) {
                // No prevenir el comportamiento por defecto en touchstart
                touchStartTime = Date.now();
                if ($(this).hasClass('fc-future')) {
                    $(this).css({
                        'border-color': '#16a34a',
                        'box-shadow': '0 0 15px rgba(74, 222, 128, 0.6), 0 0 30px rgba(74, 222, 128, 0.3)'
                    });
                }
            });

            $('.fc-day').on('touchend', function (e) {
                // Prevenir el comportamiento por defecto solo si es un tap r√°pido
                const touchDuration = Date.now() - touchStartTime;
                if (touchDuration < LONG_PRESS_DURATION) {
                    e.preventDefault();
                    handleDayClick($(this).data('date'));
                }

                if ($(this).hasClass('fc-future')) {
                    $(this).css({
                        'border-color': '#22c55e',
                        'box-shadow': '0 0 10px rgba(74, 222, 128, 0.4), 0 0 20px rgba(74, 222, 128, 0.2)'
                    });
                }
            });

            // Permitir scroll normal
            $('.fc-day').on('touchmove', function (e) {
                // No prevenir el scroll
            });

            // Prevenir el scroll solo en el modal
            $('.modal-content').on('touchmove', function (e) {
                e.stopPropagation();
            });
        }


        const styles = `
    .fc-scroller {
        -webkit-overflow-scrolling: touch;
    }

    .modal-content {
        touch-action: pan-y pinch-zoom;
    }

    .fc-day {
        touch-action: manipulation;
    }
`;

        // Agregar los estilos al documento
        if (!document.getElementById('touchStyles')) {
            $('<style>')
                .attr('id', 'touchStyles')
                .text(styles)
                .appendTo('head');
        }

        // El resto de las funciones permanecen igual...
        function handleDayClick(date) {
            selectedDate = moment(date);

            if (selectedDate.isBefore(moment(), 'day')) {
                showNotification('No se pueden realizar reservas en fechas pasadas', 'error');
                return;
            }

            openModal(date);
        }

        function openModal(date) {
            $('#selectedDateText').text(moment(date).format('DD/MM/YYYY'));
            showLoading(true);
            $('#horariosDisponibles').empty();
            $('#horariosModal').addClass('active');
            $('#btnReservar').addClass('disabled').prop('disabled', true);
            selectedHorario = null;

            fetchHorarios(date);
        }

        function fetchHorarios(date) {
            $.ajax({
                url: `/api/sala/{{ sala.id }}/horarios/${moment(date).format('YYYY-MM-DD')}/`,
                method: 'GET',
                success: handleHorariosResponse,
                error: handleHorariosError,
                complete: () => showLoading(false)
            });
        }

        function handleHorariosResponse(response) {
            const $container = $('#horariosDisponibles');
            $container.empty();

            if (response.slots_disponibles?.length > 0) {
                response.slots_disponibles.forEach(slot => {
                    createHorarioSlot(slot).appendTo($container);
                });
            } else {
                showNoHorariosMessage($container);
            }
        }

        function createHorarioSlot(slot) {
            return $('<div>')
                .addClass('horario-slot')
                .html(`
            <span class="time-icon">‚è∞</span>
            <span class="time-text">${slot.inicio} - ${slot.fin}</span>
        `)
                .data('horario', slot)
                .on('click', function () {
                    selectHorario($(this), slot);
                });
        }

        function selectHorario($slot, horario) {
            $('.horario-slot').removeClass('selected');
            $slot.addClass('selected');
            selectedHorario = horario;
            $('#btnReservar').removeClass('disabled').prop('disabled', false);
        }

        function showNoHorariosMessage($container) {
            $container.html(`
        <div class="no-horarios">
            <span class="icon">üìÖ</span>
            <p>No hay horarios disponibles para esta fecha.</p>
        </div>
    `);
        }

        function handleHorariosError() {
            showLoading(false);
            showNotification('Error al cargar los horarios. Por favor, intenta nuevamente.', 'error');
        }

        function closeModal() {
            $('#horariosModal').removeClass('active');
            selectedHorario = null;
        }

        function showLoading(show) {
            $('#loadingSpinner').toggle(show);
            $('#horariosDisponibles').toggle(!show);
        }

        function realizarReserva() {
            if (!selectedHorario) {
                showNotification('Por favor, selecciona un horario', 'warning');
                return;
            }

            const dateStr = selectedDate.format('YYYY-MM-DD');
            const url = `{% url 'reservar_sala' sala.id %}?fecha=${dateStr}&hora_inicio=${selectedHorario.inicio}&hora_fin=${selectedHorario.fin}`;

            $('body').addClass('page-transition');
            setTimeout(() => {
                window.location.href = url;
            }, 300);
        }

        function showNotification(message, type = 'info') {
            const notification = $('<div>')
                .addClass('notification ' + type)
                .text(message)
                .css({
                    'position': 'fixed',
                    'bottom': '20px',
                    'right': '20px',
                    'padding': '1rem 2rem',
                    'background': type === 'error' ? '#dc2626' : '#22c55e', // Rojo para error, verde para info
                    'color': 'white',
                    'border-radius': '8px',
                    'box-shadow': '0 0 15px rgba(34, 197, 94, 0.4)',
                    'z-index': '9999',
                    'animation': 'slideIn 0.3s ease'
                })
                .appendTo('body');

            setTimeout(() => {
                notification.css('animation', 'slideOut 0.3s ease');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Estilos de animaci√≥n
        if (!document.getElementById('notificationStyles')) {
            $('<style>')
                .attr('id', 'notificationStyles')
                .text(`
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .page-transition {
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .notification {
                font-weight: 500;
                font-size: 0.9rem;
                line-height: 1.4;
            }
        `)
                .appendTo('head');
        }
    </script>
</body>

</html>