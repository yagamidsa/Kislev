<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Bienvenido</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/restricciones.css' %}">
    <link rel="stylesheet" href="{% static 'css/formQR.css' %}">
</head>

<body>
    <div class="qr-background"></div>
    <div class="logout-button">
        {% if request.user.user_type == 'administrador' %}
        <a href="{% url 'visor_admin' %}" class="apple-btn">
            <i class="fas fa-arrow-left"></i>
            <span>Panel Admin</span>
        </a>
        {% elif request.user.user_type == 'propietario' %}
        <a href="{% url 'visor_propietario' %}" class="apple-btn">
            <i class="fas fa-arrow-left"></i>
            <span>Panel</span>
        </a>
        {% elif request.user.user_type == 'porteria' %}
        <a href="{% url 'control_porteria' %}" class="apple-btn">
            <i class="fas fa-arrow-left"></i>
            <span>Panel Portería</span>
        </a>
        {% else %}
        <div class="apple-btn" style="opacity: 0.5; cursor: not-allowed;">
            <i class="fas fa-ban"></i>
            <span>Sin acceso</span>
        </div>
        {% endif %}
    </div>

    <div class="main-content">
        <form id="formbienvenida" method="POST">
            {% csrf_token %}
            <div class="container">
                <h1 class="front-text-principal">Bienvenid@, {{ user.nombre }}!</h1>
                <h2 class="front-text">Aqui puedes generar el codigo QR para Visitante</h2>
                <label class="btn-open" for="frmContactForm"><i class="far fa-envelope"></i><span class="ml-half">Abrir
                        Formulario</span></label>
            </div>
            <input id="frmContactForm" type="checkbox" />
            <div class="contact-modal">
                <div class="contact-form">
                    <div class="contact-wrapper">
                        <div class="contact-section">
                            <h2 class="p-none m-none mb-quarter text-white"><i class="fa fa-address-card"></i><span
                                    class="ml-half">Datos Propietario</span></h2>
                        </div>
                        <div class="contact-section">
                            <div class="form-item">
                                <input type="text" id="nombre_log" name="nombre_log" value="{{user.nombre}}" readonly
                                    required>
                                <label class="lbl-floating" for="nombre_log" placeholder="Propietario"></label><i
                                    class="icon text-white fa fa-user"></i>
                            </div>
                            <div class="form-item">
                                <input type="email" id="email_creador" name="email_creador" value="{{user.email}}"
                                    readonly required>
                                <label class="lbl-floating" for="email_creador"
                                    placeholder="email Propietario"></label><i class="icon text-white fas fa-at"></i>
                            </div>
                            <div class="contact-section">
                                <h2 class="p-none m-none mb-quarter text-white"><i class="fa fa-address-card"></i><span
                                        class="ml-half">Datos Visitante</span></h2>
                            </div>
                            <div class="form-item">
                                <input type="text" placeholder=" " id="nombre" name="nombre" required>
                                <label class="lbl-floating" for="nombre">Nombre visitante</label><i
                                    class="icon text-white fa fa-user"></i>
                            </div>
                            <div class="form-item">
                                <input type="email" placeholder=" " id="email" name="email" required
                                    class="form-control" title="Por favor ingresa un email válido">
                                <label class="lbl-floating" for="email">Correo Electrónico:</label>
                                <i class="icon text-white fa fa-at"></i>
                            </div>
                            <div class="form-item">
                                <input type="number" placeholder=" " id="celular" name="celular" required>
                                <label class="lbl-floating" for="celular">Número de Celular:</label><i
                                    class="icon text-white fa fa-phone"></i>
                            </div>
                            <div class="form-item">
                                <input type="number" placeholder=" " id="cedula" name="cedula" required>
                                <label class="lbl-floating" for="cedula">Cédula Vistante:</label><i
                                    class="icon text-white fa fa-id-card"></i>
                            </div>
                            <div class="form-item">
                                <input type="number" placeholder=" " id="numper" name="numper" required>
                                <label class="lbl-floating" for="numper">Numero de personas:</label><i
                                    class="icon text-white fa fa-id-card"></i>
                            </div>
                            <div class="form-item2">
                                <i class="informativo fa fa-info-circle"
                                    style="margin-bottom: 20px; color: aliceblue;"></i>
                                <label class="cmotivo text-white" for="motivo" style="margin-left: 10px;">
                                    Motivo de la Visita:
                                </label>
                                <select id="motivo" name="motivo" required>
                                    <option value="Visita Personal">Visita Personal</option>
                                    <option value="Servicios">Servicios</option>
                                    <option value="Vista Proveedores">Vista Proveedores</option>
                                    <option value="Eventos Especiales">Eventos Especiales</option>
                                    <option value="Mantenimiento de Instalaciones">Mantenimiento de Instalaciones
                                    </option>
                                    <option value="Inspección">Inspección</option>
                                    <option value="otro">otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="container">
                            <div class="contact-section text-right">
                                <label class="contact-cancel" for="frmContactForm"><i
                                        class="fas fa-times-circle"></i><span class="ml-quarter">Cancelar</span></label>
                                <button id="submitBtn" class="btn-open2" type="submit">Generar QR<i
                                        class="far fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Configuración y Variables Globales
            const SUBMIT_COOLDOWN = 5000;
            const MAX_EMAIL_LENGTH = 254;
            const QR_CONFIG = {
                minSize: 40,
                maxSize: 80,
                minDuration: 5000,  // Reducido de 10000
                maxDuration: 10000, // Reducido de 20000
                maxQRs: 8,         // Reducido de 15
                spawnInterval: 3000 // Aumentado de 2000
            };

            let lastSubmitTime = 0;
            let isSubmitting = false;

            // Elementos del DOM
            const form = document.getElementById('formbienvenida');
            const emailInput = form.querySelector('input[name="email"]');
            const celularInput = document.getElementById('celular');
            const submitBtn = form.querySelector('#submitBtn');

            // Crear elemento para mensajes de error
            const errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.style.cssText = `
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        background-color: #ff5757;
        color: white;
        border-radius: 5px;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: opacity 0.3s ease-in-out;
    `;
            document.body.appendChild(errorDiv);

            // Funciones de utilidad mejoradas
            const showError = (message) => {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.style.opacity = '1';

                setTimeout(() => {
                    errorDiv.style.opacity = '0';
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                    }, 300);
                }, 5000);
            };

            const setSubmitButtonState = (isLoading) => {
                submitBtn.disabled = isLoading;
                submitBtn.innerHTML = isLoading ?
                    '<i class="fas fa-spinner fa-spin"></i> Enviando...' :
                    'Generar QR <i class="far fa-paper-plane"></i>';

                // Añadir/remover clase para estilo visual
                if (isLoading) {
                    submitBtn.classList.add('loading');
                } else {
                    submitBtn.classList.remove('loading');
                }
            };

            // Funciones de validación mejoradas
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            const isEmailValid = (email) => {
                return emailPattern.test(email) && email.length <= MAX_EMAIL_LENGTH;
            };

            const isCelularValid = (celular) => {
                return /^\d{10}$/.test(celular);
            };

            const validateForm = () => {
                const email = emailInput.value;
                const celular = celularInput.value;

                if (!email || !celular) {
                    showError('Todos los campos son obligatorios');
                    return false;
                }

                if (!isEmailValid(email)) {
                    showError('Por favor ingresa un correo electrónico válido');
                    return false;
                }

                if (!isCelularValid(celular)) {
                    showError('Por favor ingresa un número de celular válido de 10 dígitos');
                    return false;
                }

                return true;
            };

            // Event Listeners para validación en tiempo real
            emailInput.addEventListener('input', function (e) {
                const email = e.target.value;
                if (!isEmailValid(email)) {
                    e.target.setCustomValidity("Por favor ingresa un correo válido");
                    if (email.length > MAX_EMAIL_LENGTH) {
                        showError(`El correo no debe exceder ${MAX_EMAIL_LENGTH} caracteres`);
                    }
                } else {
                    e.target.setCustomValidity('');
                }

                // Actualizar estado visual
                this.classList.toggle('is-valid', isEmailValid(email));
                this.classList.toggle('is-invalid', !isEmailValid(email));
            });

            celularInput.addEventListener('input', function (e) {
                const celular = e.target.value.replace(/\D/g, '');
                e.target.value = celular; // Actualizar valor limpio

                if (!isCelularValid(celular)) {
                    e.target.setCustomValidity("El número debe tener 10 dígitos");
                } else {
                    e.target.setCustomValidity('');
                }

                // Actualizar estado visual
                this.classList.toggle('is-valid', isCelularValid(celular));
                this.classList.toggle('is-invalid', !isCelularValid(celular));
            });

            // Reemplaza el manejo del formulario actual por este
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                try {
                    if (isSubmitting) {
                        return;
                    }

                    const now = Date.now();
                    if (now - lastSubmitTime < SUBMIT_COOLDOWN) {
                        showError(`Por favor espera ${SUBMIT_COOLDOWN / 1000} segundos antes de enviar otro código`);
                        return;
                    }

                    if (!validateForm()) {
                        return;
                    }

                    isSubmitting = true;
                    setSubmitButtonState(true);
                    lastSubmitTime = now;

                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const formData = new FormData(form);

                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }

                    try {
                        // Intentar parsear como JSON primero
                        const data = await response.json();
                        if (data.status === 'success' && data.redirect_url) {
                            window.location.href = data.redirect_url;
                            return;
                        }
                    } catch (e) {
                        // Si no es JSON, podría ser una redirección directa
                        console.log("No es una respuesta JSON, intentando redirección directa");
                    }

                    // Si llegamos aquí, usar la URL de la respuesta
                    const redirectUrl = response.headers.get('Location') || response.url;
                    if (redirectUrl) {
                        console.log("Redirigiendo a:", redirectUrl);
                        window.location.href = redirectUrl;
                    } else {
                        showError('No se pudo determinar la URL de redirección');
                    }

                } catch (error) {
                    console.error('Error:', error);
                    showError('Error al procesar la solicitud. Por favor intenta nuevamente.');
                } finally {
                    isSubmitting = false;
                    setSubmitButtonState(false);
                }
            });

            // Efectos Visuales QR
            const qrContainer = document.createElement('div');
            qrContainer.className = 'qr-background';
            document.body.appendChild(qrContainer);

            function generateQRPattern() {
                const pattern = [];
                const size = 3;
                for (let i = 0; i < size * size; i++) {
                    pattern.push(Math.random() > 0.5);
                }
                pattern[0] = true;
                pattern[2] = true;
                pattern[6] = true;
                return pattern;
            }

            function createQR() {
                const qr = document.createElement('div');
                qr.className = 'floating-qr';

                const pattern = generateQRPattern();

                pattern.forEach((filled) => {
                    const square = document.createElement('div');
                    square.className = 'qr-square';
                    if (filled) {
                        square.classList.add('filled');
                        if (Math.random() > 0.7) {
                            square.style.animation = `qrGlow ${Math.random() * 2 + 1}s infinite alternate`;
                        }
                    }
                    qr.appendChild(square);
                });

                // Posición y animación inicial
                const startX = Math.random() * window.innerWidth;
                const startY = Math.random() * window.innerHeight;
                qr.style.left = `${startX}px`;
                qr.style.top = `${startY}px`;

                const size = Math.random() * (QR_CONFIG.maxSize - QR_CONFIG.minSize) + QR_CONFIG.minSize;
                qr.style.width = `${size}px`;
                qr.style.height = `${size}px`;

                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 300 + 200;
                qr.style.setProperty('--move-x', `${Math.cos(angle) * distance}px`);
                qr.style.setProperty('--move-y', `${Math.sin(angle) * distance}px`);
                qr.style.setProperty('--rotation', `${Math.random() * 360}deg`);

                qrContainer.appendChild(qr);

                setTimeout(() => {
                    qr.remove();
                }, QR_CONFIG.maxDuration);
            }

            // Crear QRs iniciales
            for (let i = 0; i < 10; i++) {
                setTimeout(createQR, i * 200);
            }

            // Eventos de mouse para QRs con throttling
            let lastMouseMove = 0;
            document.addEventListener('mousemove', (e) => {
                const now = Date.now();
                if (now - lastMouseMove > 100 && Math.random() > 0.7) {
                    lastMouseMove = now;
                    if (qrContainer.children.length < QR_CONFIG.maxQRs) {
                        const qr = document.createElement('div');
                        qr.className = 'floating-qr';

                        const pattern = generateQRPattern();
                        pattern.forEach((filled) => {
                            const square = document.createElement('div');
                            square.className = 'qr-square';
                            if (filled) square.classList.add('filled');
                            qr.appendChild(square);
                        });

                        qr.style.left = `${e.clientX}px`;
                        qr.style.top = `${e.clientY}px`;

                        const angle = Math.random() * Math.PI * 2;
                        const distance = Math.random() * 200 + 100;
                        qr.style.setProperty('--move-x', `${Math.cos(angle) * distance}px`);
                        qr.style.setProperty('--move-y', `${Math.sin(angle) * distance}px`);
                        qr.style.setProperty('--rotation', `${Math.random() * 360}deg`);

                        qrContainer.appendChild(qr);

                        setTimeout(() => {
                            qr.remove();
                        }, QR_CONFIG.minDuration);
                    }
                }
            });

            // Manejo de eventos de ventana
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    qrContainer.innerHTML = '';
                    for (let i = 0; i < 10; i++) {
                        createQR();
                    }
                }, 250);
            });

            // Efectos de botones
            const buttons = document.querySelectorAll('.btn-open, .btn-open2, .apple-btn');
            buttons.forEach(button => {
                button.addEventListener('mousemove', (e) => {
                    const rect = button.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    button.style.setProperty('--x', `${x}px`);
                    button.style.setProperty('--y', `${y}px`);
                });
            });
        });

    </script>



</body>

</html>