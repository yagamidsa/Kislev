<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenido</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/formQR.css' %}">
</head>

<body>
    <div class="qr-background"></div>
    <div class="logout-button">
        {% if request.user.user_type == 'administrador' %}
        <a href="{% url 'visor_admin' %}" class="apple-btn">
            <i class="fas fa-arrow-left"></i>
            <span>Panel Admin</span>
        </a>
        {% elif request.user.user_type == 'propietario' %}
        <a href="{% url 'visor_propietario' %}" class="apple-btn">
            <i class="fas fa-arrow-left"></i>
            <span>Panel</span>
        </a>
        {% elif request.user.user_type == 'porteria' %}
        <a href="{% url 'control_porteria' %}" class="apple-btn">
            <i class="fas fa-arrow-left"></i>
            <span>Panel Portería</span>
        </a>
        {% else %}
        <div class="apple-btn" style="opacity: 0.5; cursor: not-allowed;">
            <i class="fas fa-ban"></i>
            <span>Sin acceso</span>
        </div>
        {% endif %}
    </div>

    <div class="main-content">
        <form id="formbienvenida" method="POST">
            {% csrf_token %}
            <div class="container">
                <h1 class="front-text-principal">Bienvenido, {{ user.nombre }}!</h1>
                <h2 class="front-text">Aqui puedes generar el codigo QR para Visitante</h2>
                <label class="btn-open" for="frmContactForm"><i class="far fa-envelope"></i><span class="ml-half">Abrir
                        Formulario</span></label>
            </div>
            <input id="frmContactForm" type="checkbox" />
            <div class="contact-modal">
                <div class="contact-form">
                    <div class="contact-wrapper">
                        <div class="contact-section">
                            <h2 class="p-none m-none mb-quarter text-white"><i class="fa fa-address-card"></i><span
                                    class="ml-half">Datos Propietario</span></h2>
                        </div>
                        <div class="contact-section">
                            <div class="form-item">
                                <input type="text" id="nombre_log" name="nombre_log" value="{{user.nombre}}" readonly
                                    required>
                                <label class="lbl-floating" for="nombre_log" placeholder="Propietario"></label><i
                                    class="icon text-white fa fa-user"></i>
                            </div>
                            <div class="form-item">
                                <input type="email" id="email_creador" name="email_creador" value="{{user.email}}"
                                    readonly required>
                                <label class="lbl-floating" for="email_creador"
                                    placeholder="email Propietario"></label><i class="icon text-white fas fa-at"></i>
                            </div>
                            <div class="contact-section">
                                <h2 class="p-none m-none mb-quarter text-white"><i class="fa fa-address-card"></i><span
                                        class="ml-half">Datos Visitante</span></h2>
                            </div>
                            <div class="form-item">
                                <input type="text" placeholder=" " id="nombre" name="nombre" required>
                                <label class="lbl-floating" for="nombre">Nombre visitante</label><i
                                    class="icon text-white fa fa-user"></i>
                            </div>
                            <div class="form-item">
                                <input type="email" placeholder=" " id="email" name="email" required
                                    class="form-control" title="Por favor ingresa un email válido">
                                <label class="lbl-floating" for="email">Correo Electrónico:</label>
                                <i class="icon text-white fa fa-at"></i>
                            </div>
                            <div class="form-item">
                                <input type="number" placeholder=" " id="celular" name="celular" required>
                                <label class="lbl-floating" for="celular">Número de Celular:</label><i
                                    class="icon text-white fa fa-phone"></i>
                            </div>
                            <div class="form-item">
                                <input type="number" placeholder=" " id="cedula" name="cedula" required>
                                <label class="lbl-floating" for="cedula">Cédula Vistante:</label><i
                                    class="icon text-white fa fa-id-card"></i>
                            </div>
                            <div class="form-item">
                                <input type="number" placeholder=" " id="numper" name="numper" required>
                                <label class="lbl-floating" for="numper">Numero de personas:</label><i
                                    class="icon text-white fa fa-id-card"></i>
                            </div>
                            <div class="form-item2">
                                <i class="informativo fa fa-info-circle"
                                    style="margin-bottom: 20px; color: aliceblue;"></i>
                                <label class="cmotivo text-white" for="motivo" style="margin-left: 10px;">
                                    Motivo de la Visita:
                                </label>
                                <select id="motivo" name="motivo" required>
                                    <option value="Visita Personal">Visita Personal</option>
                                    <option value="Servicios">Servicios</option>
                                    <option value="Vista Proveedores">Vista Proveedores</option>
                                    <option value="Eventos Especiales">Eventos Especiales</option>
                                    <option value="Mantenimiento de Instalaciones">Mantenimiento de Instalaciones
                                    </option>
                                    <option value="Inspección">Inspección</option>
                                    <option value="otro">otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="container">
                            <div class="contact-section text-right">
                                <label class="contact-cancel" for="frmContactForm"><i
                                        class="fas fa-times-circle"></i><span class="ml-quarter">Cancelar</span></label>
                                <button id="submitBtn" class="btn-open2" type="submit">Generar QR<i
                                        class="far fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script>
        // Parte 1: Configuración Inicial y Utilidades
document.addEventListener('DOMContentLoaded', function () {
    // Configuración y Variables Globales
    const SUBMIT_COOLDOWN = 5000; // 5 segundos entre envíos
    const MAX_EMAIL_LENGTH = 254; // RFC 5321
    const QR_CONFIG = {
        minSize: 40,
        maxSize: 80,
        minDuration: 10000,
        maxDuration: 20000,
        maxQRs: 15,
        spawnInterval: 2000
    };

    let lastSubmitTime = 0;
    let isSubmitting = false;

    // Elementos del DOM
    const form = document.getElementById('formbienvenida');
    const emailInput = form.querySelector('input[name="email"]');
    const celularInput = document.getElementById('celular');
    const submitBtn = form.querySelector('#submitBtn');

    // Crear elemento para mensajes de error
    const errorDiv = document.createElement('div');
    errorDiv.id = 'error-message';
    submitBtn.closest('.contact-section').insertAdjacentElement('beforebegin', errorDiv);

    // Funciones de utilidad
    const showError = (message) => {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    };

    const setSubmitButtonState = (isLoading) => {
        submitBtn.disabled = isLoading;
        submitBtn.innerHTML = isLoading ?
            '<i class="fas fa-spinner fa-spin"></i> Enviando...' :
            'Generar QR <i class="far fa-paper-plane"></i>';
    };

    // Patrones de validación
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

    const isEmailValid = (email) => {
        return emailPattern.test(email) && email.length <= MAX_EMAIL_LENGTH;
    };

    const isCelularValid = (celular) => {
        return /^\d{10}$/.test(celular);
    };


    // Parte 2: Manejo de Eventos y Validaciones
    emailInput.addEventListener('input', function (e) {
        const email = e.target.value;
        if (!isEmailValid(email)) {
            e.target.setCustomValidity("Por favor ingresa un correo válido");
            if (email.length > MAX_EMAIL_LENGTH) {
                showError(`El correo no debe exceder ${MAX_EMAIL_LENGTH} caracteres`);
            }
        } else {
            e.target.setCustomValidity('');
        }
    });

    celularInput.addEventListener('input', function (e) {
        const celular = e.target.value;
        e.target.value = celular.replace(/\D/g, '');

        if (!isCelularValid(celular)) {
            e.target.setCustomValidity("El número debe tener 10 dígitos");
        } else {
            e.target.setCustomValidity('');
        }
    });

    // Procesamiento del QR
    const processQRScan = async (qrData) => {
        try {
            // Verificar si el QR contiene una URL válida
            const url = new URL(qrData);
            
            // Agregar el parámetro source=scan a la URL
            url.searchParams.append('source', 'scan');
            
            // Realizar la petición al backend
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'text/html,application/xhtml+xml,application/xml'
                },
                credentials: 'same-origin'
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const html = await response.text();
            document.body.innerHTML = html;

        } catch (error) {
            console.error('Error procesando QR:', error);
            showError('Error al procesar el código QR. Por favor, intente nuevamente.');
        }
    };

    // Manejo del envío del formulario
    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        try {
            const now = Date.now();
            if (now - lastSubmitTime < SUBMIT_COOLDOWN) {
                showError(`Por favor espera ${SUBMIT_COOLDOWN / 1000} segundos antes de enviar otro código`);
                return;
            }

            if (isSubmitting) return;

            const email = emailInput.value;
            const celular = celularInput.value;

            if (!isEmailValid(email)) {
                showError('Por favor ingresa un correo electrónico válido');
                return;
            }

            if (!isCelularValid(celular)) {
                showError('Por favor ingresa un número de celular válido de 10 dígitos');
                return;
            }

            isSubmitting = true;
            setSubmitButtonState(true);
            lastSubmitTime = now;

            form.submit();

        } catch (error) {
            console.error('Error:', error);
            showError('Hubo un error al procesar tu solicitud. Por favor intenta nuevamente.');
        } finally {
            isSubmitting = false;
            setSubmitButtonState(false);
        }
    });

    // Exponer la función de procesamiento QR globalmente
    window.processQRScan = processQRScan;


    // Parte 3: Efectos Visuales QR
    const qrContainer = document.createElement('div');
    qrContainer.className = 'qr-background';
    document.body.appendChild(qrContainer);

    function generateQRPattern() {
        const pattern = [];
        const size = 3;
        for (let i = 0; i < size * size; i++) {
            pattern.push(Math.random() > 0.5);
        }
        pattern[0] = true;
        pattern[2] = true;
        pattern[6] = true;
        return pattern;
    }

    function createQR() {
        const qr = document.createElement('div');
        qr.className = 'floating-qr';

        const pattern = generateQRPattern();

        pattern.forEach((filled) => {
            const square = document.createElement('div');
            square.className = 'qr-square';
            if (filled) {
                square.classList.add('filled');
                if (Math.random() > 0.7) {
                    square.style.animation = `qrGlow ${Math.random() * 2 + 1}s infinite alternate`;
                }
            }
            qr.appendChild(square);
        });

        // Posición y animación inicial
        const startX = Math.random() * window.innerWidth;
        const startY = Math.random() * window.innerHeight;
        qr.style.left = `${startX}px`;
        qr.style.top = `${startY}px`;

        // Tamaño aleatorio
        const size = Math.random() * (QR_CONFIG.maxSize - QR_CONFIG.minSize) + QR_CONFIG.minSize;
        qr.style.width = `${size}px`;
        qr.style.height = `${size}px`;

        // Movimiento aleatorio
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * 300 + 200;
        qr.style.setProperty('--move-x', `${Math.cos(angle) * distance}px`);
        qr.style.setProperty('--move-y', `${Math.sin(angle) * distance}px`);
        qr.style.setProperty('--rotation', `${Math.random() * 360}deg`);

        qrContainer.appendChild(qr);

        setTimeout(() => {
            qr.remove();
        }, QR_CONFIG.maxDuration);
    }

    // Crear QRs iniciales
    for (let i = 0; i < 10; i++) {
        setTimeout(createQR, i * 200);
    }

    // Eventos de mouse para QRs
    let lastMouseMove = 0;
    document.addEventListener('mousemove', (e) => {
        const now = Date.now();
        if (now - lastMouseMove > 100 && Math.random() > 0.7) {
            lastMouseMove = now;
            if (qrContainer.children.length < QR_CONFIG.maxQRs) {
                const qr = document.createElement('div');
                qr.className = 'floating-qr';

                const pattern = generateQRPattern();
                pattern.forEach((filled) => {
                    const square = document.createElement('div');
                    square.className = 'qr-square';
                    if (filled) square.classList.add('filled');
                    qr.appendChild(square);
                });

                qr.style.left = `${e.clientX}px`;
                qr.style.top = `${e.clientY}px`;

                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 200 + 100;
                qr.style.setProperty('--move-x', `${Math.cos(angle) * distance}px`);
                qr.style.setProperty('--move-y', `${Math.sin(angle) * distance}px`);
                qr.style.setProperty('--rotation', `${Math.random() * 360}deg`);

                qrContainer.appendChild(qr);

                setTimeout(() => {
                    qr.remove();
                }, 10000);
            }
        }
    });


    // Parte 4: Manejo de Eventos de Ventana y Botones
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            qrContainer.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                createQR();
            }
        }, 250);
    });

    // Efectos de botones
    const buttons = document.querySelectorAll('.btn-open, .btn-open2, .apple-btn');
    buttons.forEach(button => {
        button.addEventListener('mousemove', (e) => {
            const rect = button.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            button.style.setProperty('--x', `${x}px`);
            button.style.setProperty('--y', `${y}px`);
        });
    });
});


    </script>



</body>

</html>