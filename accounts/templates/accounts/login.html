<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Iniciar Sesión</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/restricciones.css' %}">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
</head>

<body>
    {% if messages %}
    <div class="message-container" role="alert">
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </div>
    {% endif %}

    {% if form.non_field_errors %}
    <div class="error-container" role="alert">
        {{ form.non_field_errors }}
    </div>
    {% endif %}

    <form method="POST" id="loginForm" action="{% url 'accounts:login' %}">
        {% csrf_token %}
        <div class="container">
            <div class="form">
                <div class="sign-in-section">
                    <h6>< Kislev /></h6>
                    <h1>Iniciar Sesión</h1>

                    <div class="form-field">
                        <label for="id_cedula">Cédula:</label>
                        <input type="text" name="cedula" id="id_cedula" required 
                               autocomplete="username" 
                               pattern="[0-9]*"
                               inputmode="numeric"
                               placeholder="Ingrese su cédula">
                        {% if form.cedula.errors %}
                        <div class="error" role="alert">{{ form.cedula.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-field">
                        <label for="id_password">Contraseña:</label>
                        <input type="password" name="password" id="id_password" required 
                               autocomplete="current-password"
                               placeholder="Ingrese su contraseña">
                        {% if form.password.errors %}
                        <div class="error" role="alert">{{ form.password.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-options">
                        <a href="{% url 'accounts:reset_password' %}">Olvidé mi contraseña</a>
                    </div>

                    <div class="form-field">
                        <input type="submit" id="submit-button" class="btn btn-signin" value="Iniciar sesión">
                    </div>

                    <div class="links">
                        <a href="#">Política de privacidad</a>
                        <a href="#">Términos y condiciones</a>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <script>
        // Función para manejar mensajes
        function handleMessages() {
            const messages = document.querySelectorAll('.message-container, .error-container');
            messages.forEach((message) => {
                message.style.animation = 'slideIn 0.3s ease-out forwards';
                
                setTimeout(() => {
                    message.style.animation = 'slideOut 0.3s ease-out forwards';
                    setTimeout(() => {
                        message.remove();
                    }, 300);
                }, 3000);
            });
        }

        // Manejar el envío del formulario
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const submitButton = document.getElementById('submit-button');
            const cedula = document.getElementById('id_cedula');
            
            // Validar campos requeridos
            if (!cedula.value) {
                e.preventDefault();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-container';
                errorDiv.setAttribute('role', 'alert');
                errorDiv.textContent = 'Por favor ingrese su cédula';
                document.body.insertBefore(errorDiv, document.body.firstChild);
                handleMessages();
                return false;
            }

            // Verificar que el token CSRF existe
            if (!csrfToken) {
                e.preventDefault();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-container';
                errorDiv.setAttribute('role', 'alert');
                errorDiv.textContent = 'Error de seguridad. Por favor, recarga la página.';
                document.body.insertBefore(errorDiv, document.body.firstChild);
                handleMessages();
                return false;
            }

            // Prevenir múltiples envíos
            if (submitButton.disabled) {
                e.preventDefault();
                return false;
            }
            submitButton.disabled = true;
            submitButton.value = 'Iniciando sesión...';
            setTimeout(() => {
                submitButton.disabled = false;
                submitButton.value = 'Iniciar sesión';
            }, 3000);
        });

        // Manejar la carga inicial de mensajes
        window.addEventListener('load', handleMessages);

        // Manejar errores de CSRF
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.toString().includes('CSRF')) {
                location.reload();
            }
        });
    </script>
</body>
</html>